#include <WiFi.h>
#include <HTTPClient.h>

#define LED_G 26
#define LED_R 27

// Falhas
#define BTN_FALHA_MEC 25
#define BTN_FALHA_ELE 32
#define BTN_FALHA_HID 33

// Setores
#define BTN_SETOR_A 19
#define BTN_SETOR_B 23
#define BTN_SETOR_C 5

#define BTN_RESET 18

const char* SSID = "Wokwi-GUEST";
const char* PASSWORD = "";
const char* SERVER_URL = "https://fastapi-6wmq.onrender.com/event";

String falha = "";
String setor = "";

unsigned long ultimoPing = 0;

void enviarEvento(const String& falha, const String& setor) {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("‚ö†Ô∏è Wi-Fi n√£o conectado.");
    return;
  }

  HTTPClient http;
  http.begin(SERVER_URL);
  http.addHeader("Content-Type", "application/json");

  String payload = "{\"device\":\"Maquina_01\",\"falha\":\"" + falha +
                   "\",\"setor\":\"" + setor + "\"}";
  int code = http.POST(payload);
  Serial.printf("üì° Enviado ‚Üí Falha: %s | Setor: %s (HTTP %d)\n",
                falha.c_str(), setor.c_str(), code);

  http.end();
}

void enviarEventoEstabilidade() {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("‚ö†Ô∏è Wi-Fi n√£o conectado.");
    return;
  }

  HTTPClient http;
  http.begin(SERVER_URL);
  http.addHeader("Content-Type", "application/json");

  String payload = "{\"device\":\"Maquina_01\",\"falha\":\"" + falha +
                   "\",\"setor\":\"" + setor + "\"}";
  int code = http.POST(payload);
  Serial.printf("");

  http.end();
}



void resetar() {
  falha = "";
  setor = "";
  digitalWrite(LED_R, LOW);
  digitalWrite(LED_G, HIGH);
  Serial.println("‚ôªÔ∏è Sistema resetado.\n");
}

void setup() {
  Serial.begin(115200);
  delay(1000);

  pinMode(LED_G, OUTPUT);
  pinMode(LED_R, OUTPUT);
  digitalWrite(LED_G, HIGH);

  int botoes[] = {
    BTN_FALHA_MEC, BTN_FALHA_ELE, BTN_FALHA_HID,
    BTN_SETOR_A, BTN_SETOR_B, BTN_SETOR_C, BTN_RESET
  };

  for (int i = 0; i < 7; i++) {
    pinMode(botoes[i], INPUT_PULLUP);
  }

  Serial.print("üîå Conectando WiFi");
  WiFi.begin(SSID, PASSWORD);

  int tentativas = 0;
  while (WiFi.status() != WL_CONNECTED && tentativas < 20) {
    delay(250);
    Serial.print(".");
    tentativas++;
  }

  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\n‚úÖ WiFi conectado!");
  } else {
    Serial.println("\n‚ùå Falha na conex√£o WiFi.");
  }
}

void loop() {
  // Falhas
  if (digitalRead(BTN_FALHA_MEC) == LOW) falha = "falha_mecanica";
  if (digitalRead(BTN_FALHA_ELE) == LOW) falha = "falha_eletrica";
  if (digitalRead(BTN_FALHA_HID) == LOW) falha = "falha_hidraulica";

  // Setores
  if (digitalRead(BTN_SETOR_A) == LOW) setor = "Setor_A";
  if (digitalRead(BTN_SETOR_B) == LOW) setor = "Setor_B";
  if (digitalRead(BTN_SETOR_C) == LOW) setor = "Setor_C";

  // Envio combinado
  if (falha.length() > 0 && setor.length() > 0) {
    enviarEvento(falha, setor);
    digitalWrite(LED_G, LOW);
    digitalWrite(LED_R, HIGH);
    falha = "";
    setor = "";
    delay(50);
  }

  // Reset
  if (digitalRead(BTN_RESET) == LOW) {
    enviarEvento("reset", "todos");
    resetar();
    delay(50);
  }

   // üíì Envia heartbeat a cada 10 segundos
  if (millis() - ultimoPing > 5000) {
    enviarEventoEstabilidade();
    ultimoPing = millis();
  }

  delay(50);
}
